<!DOCTYPE html>
<html lang="zh-TW">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>霓虹貪食蛇</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <style>
        @import url('https://fonts.googleapis.com/css2?family=Press+Start+2P&display=swap');

        body {
            background-color: #0f172a; /* Slate 900 */
            color: #e2e8f0;
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            overflow: hidden; /* Prevent scrolling on mobile */
            touch-action: none;
        }

        .pixel-font {
            font-family: 'Press Start 2P', cursive;
        }

        canvas {
            background-color: #020617; /* Darker Slate */
            box-shadow: 0 0 20px rgba(34, 211, 238, 0.2); /* Cyan glow */
            border: 2px solid #334155;
            image-rendering: pixelated;
        }

        .btn-control {
            background: rgba(255, 255, 255, 0.1);
            backdrop-filter: blur(5px);
            border: 1px solid rgba(255, 255, 255, 0.2);
            active:scale-95;
            transition: all 0.1s;
        }
        
        .btn-control:active {
            background: rgba(34, 211, 238, 0.3);
            transform: scale(0.95);
        }

        #game-overlay {
            background: rgba(15, 23, 42, 0.85);
            backdrop-filter: blur(4px);
        }
        
        /* Custom Scrollbar for leaderboard */
        .custom-scrollbar::-webkit-scrollbar {
            width: 4px;
        }
        .custom-scrollbar::-webkit-scrollbar-track {
            background: #1e293b; 
        }
        .custom-scrollbar::-webkit-scrollbar-thumb {
            background: #0ea5e9; 
            border-radius: 2px;
        }
    </style>
</head>
<body class="h-screen w-full flex flex-col items-center justify-center select-none">

    <!-- Header Info -->
    <div class="w-full max-w-md px-4 mb-2 flex justify-between items-center">
        <div class="text-center">
            <div class="text-xs text-slate-400">分數</div>
            <div id="score" class="text-2xl font-bold text-cyan-400 pixel-font">0</div>
        </div>
        <h1 class="text-xl font-bold tracking-wider text-slate-200 hidden sm:block">霓虹貪食蛇 <span id="mode-badge" class="text-xs text-cyan-500 block font-normal">載入中...</span></h1>
        <div class="text-center">
            <div class="text-xs text-slate-400">最高分</div>
            <div id="high-score" class="text-2xl font-bold text-purple-400 pixel-font">0</div>
        </div>
    </div>

    <!-- Game Container -->
    <div class="relative">
        <canvas id="gameCanvas" width="400" height="400" class="rounded-lg"></canvas>
        
        <!-- Start/Game Over Overlay -->
        <div id="game-overlay" class="absolute inset-0 rounded-lg flex flex-col items-center justify-center z-10 p-4">
            <h2 id="overlay-title" class="text-3xl font-bold text-cyan-400 mb-2 pixel-font text-center leading-relaxed">貪食蛇</h2>
            <p id="overlay-msg" class="text-xs text-slate-300 mb-4 text-center">使用方向鍵或滑動螢幕控制</p>
            
            <!-- Name Input -->
            <input type="text" id="player-name" placeholder="輸入你的名字" maxlength="8" 
                class="mb-3 px-3 py-2 bg-slate-800 border border-cyan-500/30 rounded text-cyan-100 text-center focus:outline-none focus:border-cyan-400 placeholder-slate-500 text-sm w-48 pixel-font uppercase">

            <button id="start-btn" class="mb-4 px-6 py-2 bg-cyan-500 hover:bg-cyan-400 text-black font-bold rounded shadow-[0_0_15px_rgba(6,182,212,0.5)] transition-all pixel-font text-xs w-48 disabled:opacity-50 disabled:cursor-not-allowed">
                準備中...
            </button>

            <!-- Leaderboard -->
            <div class="w-full max-w-[280px] bg-slate-900/90 rounded border border-slate-700 p-3">
                <div class="flex justify-between items-center border-b border-slate-700 pb-1 mb-2">
                    <h3 id="lb-title" class="text-xs text-cyan-300 pixel-font">排行榜</h3>
                    <div id="status-dot" class="w-2 h-2 rounded-full bg-gray-500" title="Offline"></div>
                </div>
                <ul id="leaderboard-list" class="text-xs space-y-1 overflow-y-auto max-h-[120px] pr-1 custom-scrollbar">
                    <li class="text-center text-slate-500 italic py-2">載入中...</li>
                </ul>
            </div>
        </div>
    </div>

    <!-- Mobile Controls (D-Pad Style) -->
    <div class="mt-6 grid grid-cols-3 gap-2 sm:hidden w-48">
        <div></div>
        <button class="btn-control w-14 h-14 rounded-full flex items-center justify-center text-2xl" id="btn-up">▲</button>
        <div></div>
        <button class="btn-control w-14 h-14 rounded-full flex items-center justify-center text-2xl" id="btn-left">?</button>
        <button class="btn-control w-14 h-14 rounded-full flex items-center justify-center text-2xl" id="btn-down">▼</button>
        <button class="btn-control w-14 h-14 rounded-full flex items-center justify-center text-2xl" id="btn-right">?</button>
    </div>

    <div class="text-xs text-slate-500 mt-4 hidden sm:block">
        提示：按下空白鍵可暫停遊戲
    </div>

    <script type="module">
        import { initializeApp } from 'https://www.gstatic.com/firebasejs/11.6.1/firebase-app.js';
        import { getFirestore, collection, addDoc, onSnapshot } from 'https://www.gstatic.com/firebasejs/11.6.1/firebase-firestore.js';
        import { getAuth, signInAnonymously, signInWithCustomToken, onAuthStateChanged } from 'https://www.gstatic.com/firebasejs/11.6.1/firebase-auth.js';

        // --- DOM Elements ---
        const canvas = document.getElementById('gameCanvas');
        const ctx = canvas.getContext('2d');
        const scoreEl = document.getElementById('score');
        const highScoreEl = document.getElementById('high-score');
        const overlay = document.getElementById('game-overlay');
        const overlayTitle = document.getElementById('overlay-title');
        const overlayMsg = document.getElementById('overlay-msg');
        const startBtn = document.getElementById('start-btn');
        const nameInput = document.getElementById('player-name');
        const leaderboardList = document.getElementById('leaderboard-list');
        const modeBadge = document.getElementById('mode-badge');
        const lbTitle = document.getElementById('lb-title');
        const statusDot = document.getElementById('status-dot');

        // --- Configuration & State ---
        let useFirebase = false;
        let db, auth, appId;
        let currentUser = null;
        let leaderboardData = [];
        const COLLECTION_NAME = 'snake_leaderboard';
        const LOCAL_STORAGE_KEY = 'snake_local_leaderboard';

        // --- Initialization Logic (Robust Mode) ---
        async function initSystem() {
            // Check if Firebase config exists in the environment
            if (typeof __firebase_config !== 'undefined' && __firebase_config) {
                try {
                    const firebaseConfig = JSON.parse(__firebase_config);
                    const app = initializeApp(firebaseConfig);
                    auth = getAuth(app);
                    db = getFirestore(app);
                    appId = typeof __app_id !== 'undefined' ? __app_id : 'default-app-id';
                    useFirebase = true;
                    
                    setupFirebase();
                } catch (e) {
                    console.warn("Firebase init error, falling back to local mode:", e);
                    setupLocalMode();
                }
            } else {
                console.log("No Firebase config found. Running in Offline Mode.");
                setupLocalMode();
            }
        }

        // --- Firebase Mode ---
        async function setupFirebase() {
            modeBadge.textContent = "全球連線版";
            lbTitle.textContent = "全球排行榜 TOP 10";
            statusDot.className = "w-2 h-2 rounded-full bg-green-500 animate-pulse";
            statusDot.title = "連線中";

            try {
                if (typeof __initial_auth_token !== 'undefined' && __initial_auth_token) {
                    await signInWithCustomToken(auth, __initial_auth_token);
                } else {
                    await signInAnonymously(auth);
                }
            } catch (error) {
                console.error("Auth failed:", error);
                // Fallback if auth fails
                setupLocalMode();
                return;
            }

            onAuthStateChanged(auth, (user) => {
                if (user) {
                    currentUser = user;
                    enableStartButton();
                    
                    const colRef = collection(db, 'artifacts', appId, 'public', 'data', COLLECTION_NAME);
                    onSnapshot(colRef, (snapshot) => {
                        const data = [];
                        snapshot.forEach((doc) => {
                            data.push(doc.data());
                        });
                        data.sort((a, b) => b.score - a.score);
                        leaderboardData = data.slice(0, 10);
                        updateLeaderboardUI();
                    }, (error) => {
                        console.error("Data fetch error", error);
                        if(error.code === 'permission-denied') {
                             leaderboardList.innerHTML = '<li class="text-center text-red-400 text-xs">權限過期，請重新整理</li>';
                        }
                    });
                }
            });
        }

        // --- Local Mode (Fallback) ---
        function setupLocalMode() {
            useFirebase = false;
            modeBadge.textContent = "單機版";
            lbTitle.textContent = "本機排行榜";
            statusDot.className = "w-2 h-2 rounded-full bg-orange-400";
            statusDot.title = "離線模式";
            
            // Load local data
            const saved = localStorage.getItem(LOCAL_STORAGE_KEY);
            leaderboardData = saved ? JSON.parse(saved) : [];
            
            enableStartButton();
            updateLeaderboardUI();
        }

        function enableStartButton() {
            startBtn.textContent = "開始遊戲";
            startBtn.disabled = false;
        }

        // --- Leaderboard Logic ---
        function updateLeaderboardUI() {
            leaderboardList.innerHTML = '';
            if (leaderboardData.length === 0) {
                leaderboardList.innerHTML = '<li class="text-center text-slate-500 italic py-2">暫無紀錄</li>';
                highScoreEl.textContent = '0';
                return;
            }

            highScoreEl.textContent = leaderboardData[0].score;

            leaderboardData.forEach((entry, index) => {
                const li = document.createElement('li');
                li.className = 'flex justify-between items-center ' + 
                    (index === 0 ? 'text-yellow-400' : 
                     index === 1 ? 'text-slate-300' : 
                     index === 2 ? 'text-orange-400' : 'text-slate-400');
                
                const rankSpan = document.createElement('span');
                rankSpan.className = 'w-6 font-bold';
                rankSpan.textContent = `#${index + 1}`;
                
                const nameSpan = document.createElement('span');
                nameSpan.className = 'flex-1 text-center truncate px-2';
                nameSpan.textContent = entry.name;
                
                const scoreSpan = document.createElement('span');
                scoreSpan.className = 'w-12 text-right font-mono';
                scoreSpan.textContent = entry.score;

                li.appendChild(rankSpan);
                li.appendChild(nameSpan);
                li.appendChild(scoreSpan);
                leaderboardList.appendChild(li);
            });
        }

        async function saveScore(finalScore) {
            const playerName = nameInput.value.trim() || '無名氏';
            localStorage.setItem('snakeLastPlayer', playerName);

            if (useFirebase && currentUser) {
                try {
                    const colRef = collection(db, 'artifacts', appId, 'public', 'data', COLLECTION_NAME);
                    await addDoc(colRef, {
                        name: playerName,
                        score: finalScore,
                        timestamp: Date.now(),
                        uid: currentUser.uid
                    });
                } catch (e) {
                    console.error("Error saving to cloud:", e);
                    // Optional: Could fallback to saving locally if cloud fails
                }
            } else {
                // Local Save
                leaderboardData.push({
                    name: playerName,
                    score: finalScore,
                    timestamp: Date.now()
                });
                leaderboardData.sort((a, b) => b.score - a.score);
                leaderboardData = leaderboardData.slice(0, 10);
                localStorage.setItem(LOCAL_STORAGE_KEY, JSON.stringify(leaderboardData));
                updateLeaderboardUI();
            }
        }

        // --- Game Logic (Standard) ---
        if (localStorage.getItem('snakeLastPlayer')) {
            nameInput.value = localStorage.getItem('snakeLastPlayer');
        }

        const tileCount = 20;
        let tileSize = canvas.width / tileCount - 2;
        let gameSpeed = 150;
        let snake = [];
        let food = { x: 0, y: 0 };
        let velocity = { x: 0, y: 0 };
        let nextVelocity = { x: 0, y: 0 };
        let score = 0;
        let gameLoopId;
        let isGameRunning = false;
        let isPaused = false;

        function resizeCanvas() {
            const size = Math.min(window.innerWidth - 32, 400);
            canvas.width = size;
            canvas.height = size;
            tileSize = canvas.width / tileCount;
            if (!isGameRunning) draw();
        }
        window.addEventListener('resize', resizeCanvas);
        resizeCanvas();

        function startGame() {
            const playerName = nameInput.value.trim() || '無名氏';
            localStorage.setItem('snakeLastPlayer', playerName);

            snake = [{ x: 10, y: 10 }, { x: 10, y: 11 }, { x: 10, y: 12 }];
            velocity = { x: 0, y: -1 };
            nextVelocity = { x: 0, y: -1 };
            score = 0;
            gameSpeed = 150;
            scoreEl.textContent = score;
            isGameRunning = true;
            isPaused = false;
            
            overlay.classList.add('hidden');
            placeFood();
            gameLoop();
        }

        function placeFood() {
            let valid = false;
            while (!valid) {
                food.x = Math.floor(Math.random() * tileCount);
                food.y = Math.floor(Math.random() * tileCount);
                valid = !snake.some(segment => segment.x === food.x && segment.y === food.y);
            }
        }

        function gameOver() {
            isGameRunning = false;
            clearTimeout(gameLoopId);
            
            saveScore(score);
            
            const currentTop = leaderboardData.length > 0 ? leaderboardData[0].score : 0;
            
            if (score > currentTop && score > 0) {
                overlayTitle.textContent = "新紀錄！";
                overlayTitle.className = "text-3xl font-bold text-yellow-400 mb-2 pixel-font text-center leading-relaxed animate-pulse";
            } else {
                overlayTitle.textContent = "遊戲結束";
                overlayTitle.className = "text-3xl font-bold text-cyan-400 mb-2 pixel-font text-center leading-relaxed";
            }
            
            overlayMsg.textContent = `最終分數: ${score}`;
            startBtn.textContent = "再玩一次";
            overlay.classList.remove('hidden');
        }

        function update() {
            velocity = { ...nextVelocity };
            const head = { x: snake[0].x + velocity.x, y: snake[0].y + velocity.y };

            if (head.x < 0 || head.x >= tileCount || head.y < 0 || head.y >= tileCount) { gameOver(); return; }
            if (snake.some(segment => segment.x === head.x && segment.y === head.y)) { gameOver(); return; }

            snake.unshift(head);

            if (head.x === food.x && head.y === food.y) {
                score += 10;
                scoreEl.textContent = score;
                placeFood();
                if (gameSpeed > 50) gameSpeed -= 2;
            } else {
                snake.pop();
            }
        }

        function draw() {
            ctx.fillStyle = '#020617';
            ctx.fillRect(0, 0, canvas.width, canvas.height);

            // Food
            ctx.fillStyle = '#ef4444';
            ctx.shadowColor = '#ef4444';
            ctx.shadowBlur = 15;
            ctx.beginPath();
            ctx.arc(food.x * tileSize + tileSize / 2, food.y * tileSize + tileSize / 2, tileSize / 2 - 2, 0, Math.PI * 2);
            ctx.fill();
            ctx.shadowBlur = 0;

            // Snake
            snake.forEach((segment, index) => {
                if (index === 0) {
                    ctx.fillStyle = '#22d3ee'; ctx.shadowColor = '#22d3ee'; ctx.shadowBlur = 10;
                } else {
                    ctx.fillStyle = '#0891b2'; ctx.shadowBlur = 0;
                }
                ctx.fillRect(segment.x * tileSize + 1, segment.y * tileSize + 1, tileSize - 2, tileSize - 2);
                
                // Eyes
                if (index === 0) {
                    ctx.fillStyle = 'black';
                    const eyeSize = tileSize / 5;
                    let ex1, ey1, ex2, ey2;
                    if (velocity.x === 1) { ex1 = 0.7; ey1 = 0.2; ex2 = 0.7; ey2 = 0.8; }
                    else if (velocity.x === -1) { ex1 = 0.3; ey1 = 0.2; ex2 = 0.3; ey2 = 0.8; }
                    else if (velocity.y === -1) { ex1 = 0.2; ey1 = 0.3; ex2 = 0.8; ey2 = 0.3; }
                    else { ex1 = 0.2; ey1 = 0.7; ex2 = 0.8; ey2 = 0.7; }
                    
                    ctx.fillRect(segment.x * tileSize + tileSize * ex1, segment.y * tileSize + tileSize * ey1, eyeSize, eyeSize);
                    ctx.fillRect(segment.x * tileSize + tileSize * ex2, segment.y * tileSize + tileSize * ey2, eyeSize, eyeSize);
                }
            });
        }

        function gameLoop() {
            if (!isGameRunning || isPaused) return;
            update();
            if (isGameRunning) {
                draw();
                gameLoopId = setTimeout(gameLoop, gameSpeed);
            }
        }

        function handleInput(key) {
            if (!isGameRunning) return;
            switch(key) {
                case 'ArrowUp': case 'w': if (velocity.y === 0) nextVelocity = { x: 0, y: -1 }; break;
                case 'ArrowDown': case 's': if (velocity.y === 0) nextVelocity = { x: 0, y: 1 }; break;
                case 'ArrowLeft': case 'a': if (velocity.x === 0) nextVelocity = { x: -1, y: 0 }; break;
                case 'ArrowRight': case 'd': if (velocity.x === 0) nextVelocity = { x: 1, y: 0 }; break;
                case ' ':
                    if (isGameRunning) {
                        isPaused = !isPaused;
                        if (!isPaused) gameLoop();
                        else {
                            ctx.fillStyle = 'rgba(0,0,0,0.5)'; ctx.fillRect(0,0,canvas.width, canvas.height);
                            ctx.fillStyle = 'white'; ctx.font = '20px Arial'; ctx.textAlign = 'center';
                            ctx.fillText("暫停", canvas.width/2, canvas.height/2);
                        }
                    }
                    break;
            }
        }

        document.addEventListener('keydown', (e) => handleInput(e.key));
        startBtn.addEventListener('click', startGame);
        
        // Touch events
        document.getElementById('btn-up').addEventListener('touchstart', (e) => { e.preventDefault(); handleInput('ArrowUp'); });
        document.getElementById('btn-down').addEventListener('touchstart', (e) => { e.preventDefault(); handleInput('ArrowDown'); });
        document.getElementById('btn-left').addEventListener('touchstart', (e) => { e.preventDefault(); handleInput('ArrowLeft'); });
        document.getElementById('btn-right').addEventListener('touchstart', (e) => { e.preventDefault(); handleInput('ArrowRight'); });

        let touchStartX = 0, touchStartY = 0;
        canvas.addEventListener('touchstart', (e) => { touchStartX = e.changedTouches[0].screenX; touchStartY = e.changedTouches[0].screenY; }, {passive: false});
        canvas.addEventListener('touchend', (e) => {
            e.preventDefault();
            let touchEndX = e.changedTouches[0].screenX, touchEndY = e.changedTouches[0].screenY;
            let dx = touchEndX - touchStartX, dy = touchEndY - touchStartY;
            if (Math.abs(dx) > Math.abs(dy)) { if (Math.abs(dx) > 30) handleInput(dx > 0 ? 'ArrowRight' : 'ArrowLeft'); }
            else { if (Math.abs(dy) > 30) handleInput(dy > 0 ? 'ArrowDown' : 'ArrowUp'); }
        }, {passive: false});

        // Boot up
        draw();
        initSystem();

    </script>
</body>
</html>